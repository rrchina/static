(function(a){a.fn.fSelect=function(f){var d;if(typeof f=="string"){d=f}else{d=a.extend({placeholder:"请选择",numDisplayed:3,overflowText:"已选择{n}个",searchText:"搜索",width:200,bg:"#ffffff",showSearch:true,onshow:null},f)}function e(g,h){this.$select=a(g);this.settings=h;this.create()}e.prototype={create:function(){var g=this.$select.is("[multiple]")?" multiple":"";this.$select.wrap('<div class="fs-wrap'+g+'" style="width:'+this.settings.width+"px;"+(this.settings.bg?"background:"+this.settings.bg:"")+'"></div>');this.$select.before('<div class="fs-label-wrap"><div class="fs-label">'+this.settings.placeholder+'</div><span class="fs-arrow"></span></div>');this.$select.before('<div class="fs-dropdown fs-hidden"><div class="fs-options"></div></div>');this.$select.addClass("fs-hidden");this.$wrap=this.$select.closest(".fs-wrap");if(this.settings.showSearch){var h='<div class="fs-search"><input type="search" placeholder="'+this.settings.searchText+'" /></div>';this.$wrap.find(".fs-dropdown").prepend(h)}this.reload()},reload:function(){var g=this.buildOptions(this.$select);this.$wrap.find(".fs-options").html(g);this.reloadDropdownLabel()},destroy:function(){this.$wrap.find(".fs-label-wrap").remove();this.$wrap.find(".fs-dropdown").remove();this.$select.unwrap().removeClass("fs-hidden")},buildOptions:function(g){var h=this;var i="";g.children().each(function(l,k){var j=a(k);if("optgroup"==j.prop("nodeName").toLowerCase()){i+='<div class="fs-optgroup">';i+='<div class="fs-optgroup-label">'+j.prop("label")+"</div>";i+=h.buildOptions(j);i+="</div>"}else{var m=j.is(":selected")?" selected":"";i+='<div class="fs-option'+m+'" data-value="'+j.prop("value")+'"><span class="fs-checkbox"><i></i></span><div class="fs-option-label">'+j.html()+"</div></div>"}});return i},reloadDropdownLabel:function(){var h=this.settings;var g=[];this.$wrap.find(".fs-option.selected").each(function(k,j){g.push(a(j).find(".fs-option-label").text())});if(g.length<1){g=h.placeholder}else{if(g.length>h.numDisplayed){g=h.overflowText.replace("{n}",g.length)}else{g=g.join(", ")}}this.$wrap.find(".fs-label").html(g);this.$select.change()}};return this.each(function(){var g=a(this).data("fSelect");if(!g){g=new e(this,d);a(this).data("fSelect",g);a(this).closest(".fs-wrap").data("rsettings",d)}if(typeof d=="string"){g[d]()}})};window.fSelect={active:null,idx:-1};function b(d){d.find(".fs-option:not(.fs-hidden)").each(function(f,e){a(e).attr("data-index",f);d.find(".fs-option").removeClass("hl")});window.fSelect.idx=-1}function c(f){var d=f.find(".fs-options");var e=f.find(".fs-option.hl");var j=e.offset().top+d.scrollTop();var i=j+e.outerHeight();var h=d.offset().top+d.scrollTop();var g=h+d.outerHeight();if(i>g){var k=d.scrollTop()+i-g;d.scrollTop(k)}else{if(j<h){var k=d.scrollTop()-h-j;d.scrollTop(k)}}}a(document).on("click",".fs-option",function(){var d=a(this).closest(".fs-wrap");if(d.hasClass("multiple")){var e=[];a(this).toggleClass("selected");d.find(".fs-option.selected").each(function(g,f){e.push(a(f).attr("data-value"))})}else{var e=a(this).attr("data-value");d.find(".fs-option").removeClass("selected");a(this).addClass("selected");d.find(".fs-dropdown").addClass("fs-hidden")}d.find("select").val(e);d.find("select").fSelect("reloadDropdownLabel")});a(document).on("keyup",".fs-search input",function(f){if(40==f.which){a(this).blur();return}var d=a(this).closest(".fs-wrap");var g=a(this).val();d.find(".fs-option, .fs-optgroup-label").removeClass("fs-hidden");if(""!=g){d.find(".fs-option").each(function(){var e=new RegExp(g,"gi");if(null===a(this).find(".fs-option-label").text().match(e)){a(this).addClass("fs-hidden")}});d.find(".fs-optgroup-label").each(function(){var e=a(this).closest(".fs-optgroup").find(".fs-option:not(.fs-hidden)").length;if(e<1){a(this).addClass("fs-hidden")}})}b(d)});a(document).on("click",function(g){var d=a(g.target);var f=d.closest(".fs-wrap");if(0<f.length){if(d.hasClass("fs-label")||d.hasClass("fs-arrow")){window.fSelect.active=f;var h=f.find(".fs-dropdown").hasClass("fs-hidden");a(".fs-dropdown").addClass("fs-hidden");if(h){f.find(".fs-dropdown").removeClass("fs-hidden");f.find(".fs-search input").focus();if(f.data("rsettings").onshow){f.data("rsettings").onshow(f)}}else{f.find(".fs-dropdown").addClass("fs-hidden")}b(f)}}else{a(".fs-dropdown").addClass("fs-hidden");window.fSelect.active=null}});a(document).on("keydown",function(f){var d=window.fSelect.active;if(null===d){return}else{if(38==f.which){f.preventDefault();d.find(".fs-option").removeClass("hl");if(window.fSelect.idx>0){window.fSelect.idx--;d.find(".fs-option[data-index="+window.fSelect.idx+"]").addClass("hl");c(d)}else{window.fSelect.idx=-1;d.find(".fs-search input").focus()}}else{if(40==f.which){f.preventDefault();var g=d.find(".fs-option:last").attr("data-index");if(window.fSelect.idx<parseInt(g)){window.fSelect.idx++;d.find(".fs-option").removeClass("hl");d.find(".fs-option[data-index="+window.fSelect.idx+"]").addClass("hl");c(d)}}else{if(32==f.which||13==f.which){d.find(".fs-option.hl").click()}else{if(27==f.which){a(".fs-dropdown").addClass("fs-hidden");window.fSelect.active=null}}}}}})})(jQuery);